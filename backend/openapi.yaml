openapi: 3.0.3
info:
  title: Grandson Pill Pal API
  description: |
    API for Grandson Pill Pal - A medication reminder service for helping loved ones 
    (especially grandparents) remember to take their pills on time.
    
    The API allows creating prescriptions with medication items and scheduling
    SMS reminders to be sent to a specified phone number.
  version: 1.0.0
  contact:
    name: Grandson Pill Pal Support
  license:
    name: MIT

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.grandsonpillpal.example.com/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Prescriptions
    description: Prescription management
  - name: Reminders
    description: Reminder management

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check if the API is running and healthy
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /prescriptions:
    post:
      tags:
        - Prescriptions
      summary: Create a new prescription
      description: |
        Create a new prescription with medication items and schedule reminders
        to be sent to the specified phone number.
      operationId: createPrescription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePrescriptionRequest'
            examples:
              basic:
                summary: Basic prescription
                value:
                  phone_number: "+1 555 123 4567"
                  items:
                    - text: "Take 1 blue pill every morning with food"
                    - text: "Take 2 white pills at night before bed"
                  language: "en"
      responses:
        '201':
          description: Prescription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'

    get:
      tags:
        - Prescriptions
      summary: List all prescriptions
      description: Get a list of all prescriptions, optionally filtered by phone number
      operationId: listPrescriptions
      parameters:
        - name: phone_number
          in: query
          description: Filter prescriptions by phone number
          required: false
          schema:
            type: string
            example: "+1 555 123 4567"
        - name: status
          in: query
          description: Filter by prescription status
          required: false
          schema:
            $ref: '#/components/schemas/PrescriptionStatus'
        - name: limit
          in: query
          description: Maximum number of results to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of results to skip for pagination
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of prescriptions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrescriptionList'

  /prescriptions/{prescription_id}:
    get:
      tags:
        - Prescriptions
      summary: Get a prescription by ID
      description: Retrieve a specific prescription by its ID
      operationId: getPrescription
      parameters:
        - $ref: '#/components/parameters/PrescriptionId'
      responses:
        '200':
          description: Prescription found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'
        '404':
          description: Prescription not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Prescriptions
      summary: Update a prescription
      description: Update an existing prescription's items or phone number
      operationId: updatePrescription
      parameters:
        - $ref: '#/components/parameters/PrescriptionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePrescriptionRequest'
      responses:
        '200':
          description: Prescription updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Prescription not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Prescriptions
      summary: Delete a prescription
      description: Delete a prescription and cancel all associated reminders
      operationId: deletePrescription
      parameters:
        - $ref: '#/components/parameters/PrescriptionId'
      responses:
        '204':
          description: Prescription deleted successfully
        '404':
          description: Prescription not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /prescriptions/{prescription_id}/status:
    patch:
      tags:
        - Prescriptions
      summary: Update prescription status
      description: Activate, pause, or deactivate a prescription's reminders
      operationId: updatePrescriptionStatus
      parameters:
        - $ref: '#/components/parameters/PrescriptionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  $ref: '#/components/schemas/PrescriptionStatus'
      responses:
        '200':
          description: Status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Prescription'
        '404':
          description: Prescription not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /prescriptions/{prescription_id}/reminders:
    get:
      tags:
        - Reminders
      summary: Get reminders for a prescription
      description: List all scheduled reminders for a specific prescription
      operationId: getPrescriptionReminders
      parameters:
        - $ref: '#/components/parameters/PrescriptionId'
        - name: status
          in: query
          description: Filter by reminder status
          required: false
          schema:
            $ref: '#/components/schemas/ReminderStatus'
      responses:
        '200':
          description: List of reminders
          content:
            application/json:
              schema:
                type: object
                properties:
                  reminders:
                    type: array
                    items:
                      $ref: '#/components/schemas/Reminder'
                  total:
                    type: integer
        '404':
          description: Prescription not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  parameters:
    PrescriptionId:
      name: prescription_id
      in: path
      description: Unique identifier of the prescription
      required: true
      schema:
        type: string
        format: uuid
        example: "550e8400-e29b-41d4-a716-446655440000"

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
          example: healthy
        timestamp:
          type: string
          format: date-time
          example: "2026-01-26T12:00:00Z"
        version:
          type: string
          example: "1.0.0"

    CreatePrescriptionRequest:
      type: object
      required:
        - phone_number
        - items
      properties:
        phone_number:
          type: string
          description: Phone number to send reminders to (E.164 format recommended)
          example: "+15551234567"
          minLength: 10
          maxLength: 20
        items:
          type: array
          description: List of medication items
          minItems: 1
          maxItems: 50
          items:
            $ref: '#/components/schemas/PrescriptionItemInput'
        language:
          type: string
          description: Preferred language for reminder messages
          enum: [en, es]
          default: en
        timezone:
          type: string
          description: Timezone for scheduling reminders
          example: "America/New_York"
          default: "UTC"
        recipient_name:
          type: string
          description: Name of the person receiving reminders
          example: "Grandma Rose"
          maxLength: 100

    UpdatePrescriptionRequest:
      type: object
      properties:
        phone_number:
          type: string
          description: Phone number to send reminders to
          example: "+15551234567"
          minLength: 10
          maxLength: 20
        items:
          type: array
          description: List of medication items (replaces existing items)
          minItems: 1
          maxItems: 50
          items:
            $ref: '#/components/schemas/PrescriptionItemInput'
        language:
          type: string
          enum: [en, es]
        timezone:
          type: string
          example: "America/New_York"
        recipient_name:
          type: string
          maxLength: 100

    PrescriptionItemInput:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: Medication instruction text
          example: "Take 1 blue pill every morning with food"
          minLength: 1
          maxLength: 500
        schedule:
          $ref: '#/components/schemas/ReminderSchedule'

    ReminderSchedule:
      type: object
      description: Optional custom schedule for this medication
      properties:
        times:
          type: array
          description: Times of day to send reminders (24h format)
          items:
            type: string
            pattern: '^([01]?[0-9]|2[0-3]):[0-5][0-9]$'
            example: "08:00"
        days_of_week:
          type: array
          description: Days of the week to send reminders (0=Sunday, 6=Saturday)
          items:
            type: integer
            minimum: 0
            maximum: 6
          example: [0, 1, 2, 3, 4, 5, 6]

    Prescription:
      type: object
      required:
        - id
        - phone_number
        - items
        - status
        - created_at
        - updated_at
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier
          example: "550e8400-e29b-41d4-a716-446655440000"
        phone_number:
          type: string
          example: "+15551234567"
        items:
          type: array
          items:
            $ref: '#/components/schemas/PrescriptionItem'
        language:
          type: string
          enum: [en, es]
          example: en
        timezone:
          type: string
          example: "America/New_York"
        recipient_name:
          type: string
          example: "Grandma Rose"
        status:
          $ref: '#/components/schemas/PrescriptionStatus'
        created_at:
          type: string
          format: date-time
          example: "2026-01-26T12:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2026-01-26T12:00:00Z"

    PrescriptionItem:
      type: object
      required:
        - id
        - text
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for this item
        text:
          type: string
          description: Medication instruction text
          example: "Take 1 blue pill every morning with food"
        schedule:
          $ref: '#/components/schemas/ReminderSchedule'

    PrescriptionStatus:
      type: string
      enum:
        - active
        - paused
        - completed
        - cancelled
      description: |
        - active: Reminders are being sent
        - paused: Reminders are temporarily stopped
        - completed: Prescription has ended
        - cancelled: Prescription was cancelled

    PrescriptionList:
      type: object
      required:
        - prescriptions
        - total
        - limit
        - offset
      properties:
        prescriptions:
          type: array
          items:
            $ref: '#/components/schemas/Prescription'
        total:
          type: integer
          description: Total number of prescriptions matching the query
          example: 42
        limit:
          type: integer
          example: 20
        offset:
          type: integer
          example: 0

    Reminder:
      type: object
      required:
        - id
        - prescription_id
        - item_id
        - scheduled_at
        - status
      properties:
        id:
          type: string
          format: uuid
        prescription_id:
          type: string
          format: uuid
        item_id:
          type: string
          format: uuid
        message:
          type: string
          description: The reminder message that was/will be sent
          example: "ðŸ’Š Hey there! Time for your morning medicine! Take 1 blue pill with food. You got this! ðŸ’ª"
        scheduled_at:
          type: string
          format: date-time
          description: When the reminder is/was scheduled to be sent
        sent_at:
          type: string
          format: date-time
          description: When the reminder was actually sent (null if not yet sent)
        status:
          $ref: '#/components/schemas/ReminderStatus'

    ReminderStatus:
      type: string
      enum:
        - pending
        - sent
        - failed
        - cancelled
      description: |
        - pending: Reminder is scheduled but not yet sent
        - sent: Reminder was successfully sent
        - failed: Reminder failed to send
        - cancelled: Reminder was cancelled

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "not_found"
        message:
          type: string
          description: Human-readable error message
          example: "Prescription not found"
        details:
          type: object
          description: Additional error details
          additionalProperties: true

    ValidationErrorResponse:
      type: object
      required:
        - error
        - message
        - details
      properties:
        error:
          type: string
          example: "validation_error"
        message:
          type: string
          example: "Request validation failed"
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: "phone_number"
              message:
                type: string
                example: "Invalid phone number format"
              code:
                type: string
                example: "invalid_format"
